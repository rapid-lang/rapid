
OCAMLC=ocamlc
OCAMLDEP=ocamldep
OCAMLLEX=ocamllex
OCAMLYACC=ocamlyacc

RAPID_OBJS  = ast_helper.cmo parser.cmo scanner.cmo sast_helper.cmo sast_printer.cmo translate.cmo semantic_check.cmo \
	generate.cmo compile.cmo rapid.cmo
PARSER_OBJS = ast_helper.cmo parser.cmo scanner.cmo test_parser.cmo
SAST_OBJS   = ast_helper.cmo parser.cmo scanner.cmo sast_helper.cmo sast_printer.cmo translate.cmo semantic_check.cmo \
		  test_sast.cmo

all: clean parser sast rapid

rapid: $(RAPID_OBJS)
	$(OCAMLC) -o rapid $(RAPID_OBJS)

parser: $(PARSER_OBJS)
	$(OCAMLC) -o parser $(PARSER_OBJS)

sast: $(SAST_OBJS)
	$(OCAMLC) -o sast $(SAST_OBJS)

test: all parser_tests.sh sast_tests.sh compiler_tests.sh
	./parser_tests.sh
	./sast_tests.sh
	./compiler_tests.sh

scanner.ml: scanner.mll
	$(OCAMLLEX) scanner.mll

parser.ml parser.mli: parser.mly
	$(OCAMLYACC) parser.mly

tar: $(TARFILES)
	cd .. && tar czf rapid.tar.gz `git ls-files compiler`

.PHONY: clean parser test all
clean:
	rm -f rapid microc parser sast parser.ml parser.mli scanner.ml \
		*.cmo *.cmi *.out *.diff

%.cmo: %.ml
	$(OCAMLC) -w A -c $<

%.cmi: %.mli
	$(OCAMLC) -w A -c $<

# Generated by ocamldep *.mli *.ml
ast.cmi :
parser.cmi : ast.cmi
sast.cmi : ast.cmi
ast_helper.cmo : ast.cmi
ast_helper.cmx : ast.cmi
compile.cmo : semantic_check.cmo generate.cmo ast.cmi
compile.cmx : semantic_check.cmx generate.cmx ast.cmi
generate.cmo : sast_printer.cmo sast.cmi
generate.cmx : sast_printer.cmx sast.cmi
parser.cmo : ast_helper.cmo ast.cmi parser.cmi
parser.cmx : ast_helper.cmx ast.cmi parser.cmi
rapid.cmo : scanner.cmo parser.cmi compile.cmo ast_helper.cmo
rapid.cmx : scanner.cmx parser.cmx compile.cmx ast_helper.cmx
sast_helper.cmo : sast.cmi
sast_helper.cmx : sast.cmi
sast_printer.cmo : sast.cmi
sast_printer.cmx : sast.cmi
scanner.cmo : parser.cmi
scanner.cmx : parser.cmx
semantic_check.cmo : translate.cmo sast_printer.cmo sast_helper.cmo sast.cmi \
    ast_helper.cmo ast.cmi
semantic_check.cmx : translate.cmx sast_printer.cmx sast_helper.cmx sast.cmi \
    ast_helper.cmx ast.cmi
test_parser.cmo : scanner.cmo parser.cmi ast_helper.cmo
test_parser.cmx : scanner.cmx parser.cmx ast_helper.cmx
test_sast.cmo : semantic_check.cmo scanner.cmo parser.cmi ast_helper.cmo
test_sast.cmx : semantic_check.cmx scanner.cmx parser.cmx ast_helper.cmx
translate.cmo : sast_printer.cmo sast_helper.cmo sast.cmi ast_helper.cmo \
    ast.cmi
translate.cmx : sast_printer.cmx sast_helper.cmx sast.cmi ast_helper.cmx \
    ast.cmi
